general:
  artifacts:
    - /home/ubuntu/PTSD/app/build/outputs/

machine:
  environment:
    # Use a longer timeout to prevent timeout errors
    ADB_INSTALL_TIMEOUT: 60 # minutes (2 minutes by default)

test:
  override:
  
    # The files containing API keys are not tracked in git
    # Write them from environment variables
    - echo $google_services_json3 > app/google-services.json
    - echo $ids_xml_3 > app/src/main/res/values/ids.xml
    
    # start the emulator
    - emulator -avd circleci-android22 -no-audio -no-window:
        background: true
        parallel: true
    # wait for it to have booted
    - circle-android wait-for-boot
    
    # Keep waiting to make sure it has fully loaded
    - sleep 30 # seconds
    
    # Remove the lockscreen
    - adb shell input keyevent 82
    
    # Take screenshot and copy it to file on host computer
    - adb shell screencap -p | perl -pe 's/\x0D\x0A/\x0A/g' > screenshot.png
    
    # Run tests against the emulator.
    - ./gradlew installDebug
    
    - adb shell screencap -p | perl -pe 's/\x0D\x0A/\x0A/g' > screenshot2.png
    
    - adb shell am start -n com.tytanapps.ptsd/com.tytanapps.ptsd.MainActivity
    
    - adb shell screencap -p | perl -pe 's/\x0D\x0A/\x0A/g' > screenshot3.png
    
    
    - ./gradlew connectedAndroidTest
    
    # copy the build outputs to artifacts
    # - cp -r home/ubuntu/PTSD/app/build/outputs $CIRCLE_ARTIFACTS
    - cp screenshot.png $CIRCLE_ARTIFACTS
    - cp screenshot2.png $CIRCLE_ARTIFACTS
    - cp screenshot3.png $CIRCLE_ARTIFACTS
    
    # copy the test results to the test results directory.
    - cp /home/ubuntu/PTSD/app/build/reports/androidTests/connected/index.html $CIRCLE_TEST_REPORTS
    # - cp -r home/ubuntu/PTSD/app/build/outputs/androidTest-results/* $CIRCLE_TEST_REPORTS