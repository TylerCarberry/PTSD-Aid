# For an example circle.yml, see https://github.com/halvards/android-travis-spike/blob/master/initialize-android.sh

general:
  artifacts:
    - PTSD

machine:
  environment:
    # Use a longer timeout to prevent timeout errors
    # See https://code.google.com/p/android/issues/detail?id=189764
    ADB_INSTALL_TIMEOUT: 6000
    
    # Limit memory usage to avoid the 4gb limit on CircleCi
    # See https://circleci.com/docs/oom/#out-of-memory-errors-in-android-builds
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
    
    TERM: "dumb"
    
dependencies:
  pre:
    # Update the avd
    - ( sleep 5 && while [ 1 ]; do sleep 1; echo y; done ) | android update sdk --no-ui --all
    - ( sleep 5 && while [ 1 ]; do sleep 1; echo y; done ) | android update sdk --no-ui --all --filter tool,extra-android-m2repository,extra-android-support,extra-google-google_play_services,extra-google-m2repository,android-23,android-22,sys-img-armeabi-v7a-google_apis-23,sys-img-armeabi-v7a-google_apis-22
    
    - echo y | android update sdk --all --no-ui --filter android-22
    - echo y | android update sdk --all --no-ui --filter addon-google_apis-google-22 # Google APIs, use with sys-img-armeabi-v7a-addon-google_apis-google-22
    - echo y | android update sdk --all --no-ui --filter sys-img-armeabi-v7a-addon-google_apis-google-22 # System image, requires android-22 and addon-google_apis-google-22, provides Google APIs
    - echo y | android update sdk --all --no-ui --filter sys-img-armeabi-v7a-android-22 # System image, requires android-22

    
  # override:
    # - export TERM="dumb"
    # - if [ -e ./gradlew ]; then ./gradlew dependencies;else gradle dependencies;fi

test:
  override:
  
    # The files containing API keys are not tracked in git
    # Write them from environment variables
    - echo $google_services_json4 > app/google-services.json
    - echo $ids_xml_3 > app/src/main/res/values/ids.xml
    
    # - android create avd --force -n test -t "Google Inc.:Google APIs:22" --abi armeabi-v7a --tag google_apis
    
    - android list targets
    
    - echo no | android create avd --force --name test --target "android-22" --abi "google_apis/armeabi-v7a"
    
    # Start the emulator
    - emulator -avd test -no-audio -no-window:
        background: true
        parallel: true
    
    # Wait for the emulator to have booted
    - circle-android wait-for-boot
    
    # unlock the emulator screen
    - sleep 30
    - adb shell input keyevent 82
    
    # run tests  against the emulator.
    - ./gradlew connectedAndroidTest -PdisablePreDex
    
    # - ./gradlew build
  
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/app/build/outputs/androidTest-results/connected/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
